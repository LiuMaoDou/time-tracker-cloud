<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡æ—¶é—´è®°å½•ç³»ç»Ÿ - Cloud Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* æ ¸å¿ƒé…è‰²å˜é‡ */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --warning-color: #ed8936;
            --info-color: #4299e1;
            --plan-color: #4a90e2; 
            --text-main: #2d3748;
            --text-sub: #718096;
            --bg-gray: #f7fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Ubuntu', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-main);
            line-height: 1.5;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        .container {
            max-width: 1600px; 
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 40px;
        }

        h1 {
            color: var(--text-main);
            text-align: center;
            margin-bottom: 40px;
            font-weight: 800;
            font-size: 2.2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* å¸ƒå±€æ”¯æŒ4åˆ— */
        .main-layout { display: flex; gap: 20px; }
        .left-section { flex: 1.2; min-width: 300px; }
        .plan-section-container { flex: 1; min-width: 280px; } 
        .middle-section { flex: 1; min-width: 280px; }
        .right-section { flex: 1; min-width: 280px; }

        /* æ–‡ä»¶æ§åˆ¶åŒº */
        .file-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--shadow-sm);
        }

        .file-controls input[type="file"] { display: none; }

        /* é€šç”¨æŒ‰é’®åŸºç¡€æ ·å¼ */
        .file-controls label, 
        .file-controls button {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* åŠ è½½æŒ‰é’® */
        .file-controls label {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        .file-controls label:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(102, 126, 234, 0.4); }

        /* æœ¬åœ°å¤‡ä»½æŒ‰é’® (ç™½è‰²) */
        .file-controls .btn-local-save { 
            background: white; 
            color: var(--text-main); 
            border: 1px solid var(--border-color); 
        }
        .file-controls .btn-local-save:hover { background: var(--bg-gray); border-color: #cbd5e0; transform: translateY(-1px); }

        /* äº‘ç«¯å¤‡ä»½æŒ‰é’® (ç´«è‰²/ä¸»è‰²) */
        .file-controls .btn-cloud-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(118, 75, 162, 0.3);
        }
        .file-controls .btn-cloud-save:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* å¯¼å‡ºè¡¨æ ¼æŒ‰é’® (è“è‰²) */
        .file-controls .btn-finish {
            background: var(--info-color);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
            margin-left: auto; 
        }
        .file-controls .btn-finish:hover {
            background: #3182ce; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.4); 
        }

        /* æ—¶é’Ÿæ ·å¼ */
        .clock-display {
            font-family: 'Ubuntu', monospace;
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
            background: var(--bg-gray);
            padding: 5px 15px;
            border-radius: var(--radius-sm);
            margin-left: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            height: 42px;
            letter-spacing: 1px;
        }

        .auto-save-status {
            font-size: 14px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-left: 15px;
        }

        .save-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            margin-right: 8px;
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(72, 187, 120, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ */
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: all 0.2s;
            background: #fff;
            color: var(--text-main);
            font-family: inherit;
        }

        input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }

        button:active { transform: scale(0.98); }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-start { background: var(--success-color); color: white; box-shadow: 0 2px 5px rgba(72, 187, 120, 0.3); }
        .btn-start:hover:not(:disabled) { background: #38a169; transform: translateY(-1px); }

        .btn-pause { background: var(--warning-color); color: white; box-shadow: 0 2px 5px rgba(237, 137, 54, 0.3); }
        .btn-pause:hover:not(:disabled) { background: #dd6b20; transform: translateY(-1px); }

        .btn-stop { background: var(--danger-color); color: white; box-shadow: 0 2px 5px rgba(245, 101, 101, 0.3); }
        .btn-stop:hover:not(:disabled) { background: #e53e3e; transform: translateY(-1px); }

        .btn-delete {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid rgba(245, 101, 101, 0.2);
            padding: 6px 12px;
            font-size: 13px;
        }
        .btn-delete:hover { background: #fff5f5; border-color: var(--danger-color); }

        .btn-add-todo, .btn-add-question {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(118, 75, 162, 0.3);
        }
        .btn-add-todo:hover, .btn-add-question:hover { background: #6b46c1; transform: translateY(-1px); }

        /* è§„åˆ’æŒ‰é’® */
        .btn-add-plan {
            background: var(--plan-color);
            color: white;
            box-shadow: 0 2px 5px rgba(74, 144, 226, 0.3);
        }
        .btn-add-plan:hover { background: #357abd; transform: translateY(-1px); }

        .btn-save-modal { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-save-modal:hover { background: var(--bg-gray); border-color: #cbd5e0; }

        .btn-small { padding: 6px 12px; font-size: 13px; }

        /* è®¡æ—¶å™¨åŒºåŸŸ */
        .task-input-section { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin-bottom: 25px; 
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }
        
        .task-input-section input { width: 100%; }

        .task-buttons-row {
            display: flex;
            gap: 10px; 
            width: 100%;
        }

        .task-buttons-row button { flex: 1; }

        .current-task {
            background: #fff;
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .current-task h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-sub);
            margin-bottom: 10px;
        }

        #currentTaskName {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .timer {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary-color);
            font-variant-numeric: tabular-nums;
            text-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        /* åŒºåŸŸå®¹å™¨ */
        .records, .todo-section, .question-section, .plan-section { 
            margin-bottom: 20px; 
            background: var(--bg-gray); 
            padding: 25px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(0,0,0,0.03);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        #recordsList, #todoList, #questionList, #planList {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* åˆ—è¡¨é¡¹ */
        .record-item, .todo-item, .question-item, .plan-item {
            background: white;
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.25s ease;
            position: relative;
        }

        .record-item:hover, .todo-item:hover, .question-item:hover, .plan-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: #cbd5e0;
        }

        /* è®°å½•è¯¦æƒ… */
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .record-task { font-weight: 700; font-size: 16px; color: var(--text-main); }
        
        .record-time { 
            color: var(--primary-color); 
            font-weight: 700; 
            font-family: 'Ubuntu', sans-serif; 
            font-size: 14px; 
        }
        
        .record-desc {
            font-size: 14px;
            color: var(--text-sub);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            background: #fafafa;
            padding: 10px;
            border-radius: 6px;
        }

        /* å¾…åŠäº‹é¡¹ */
        .todo-item { display: flex; align-items: center; justify-content: space-between; }
        .todo-item.completed { opacity: 0.6; background: #f9f9f9; }
        .todo-item.overdue { border-left: 4px solid var(--danger-color); }

        .todo-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
            margin-right: 15px;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 3px;
            cursor: pointer;
            border-radius: 4px;
            border: 2px solid #cbd5e0;
        }

        .todo-text { font-weight: 700; color: var(--text-main); font-size: 15px; }
        .todo-subtitle { font-size: 13px; color: var(--text-sub); margin-top: 4px; }
        
        .todo-deadline {
            font-size: 12px;
            color: var(--warning-color);
            margin-top: 4px;
            font-weight: 600;
            background: rgba(237, 137, 54, 0.1);
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* è§„åˆ’åˆ—è¡¨é¡¹ */
        .plan-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .plan-item.completed { opacity: 0.6; background: #f9f9f9; text-decoration: line-through; }
        
        .plan-content {
            font-weight: 700;
            color: var(--text-main);
            font-size: 15px;
        }
        .plan-deadline {
            font-size: 12px;
            color: var(--plan-color);
            background: rgba(74, 144, 226, 0.1);
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .plan-actions {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        .btn-plan-action {
            flex: 1;
            font-size: 12px;
            padding: 6px;
            box-shadow: none;
            border: 1px solid var(--border-color);
        }
        .btn-to-footprint { background: white; color: var(--success-color); border-color: var(--success-color); }
        .btn-to-footprint:hover { background: #f0fff4; }
        
        .btn-to-todo { background: white; color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-to-todo:hover { background: #f3ebff; }


        /* çµæ„Ÿ/é—®é¢˜ */
        .question-item { display: flex; justify-content: space-between; align-items: center; }
        .question-item.answered { border-left: 4px solid var(--success-color); }
        
        .question-content { flex: 1; margin-right: 15px; cursor: pointer; }
        .question-text { font-weight: 500; font-size: 15px; }
        .question-status {
            font-size: 12px;
            color: var(--success-color);
            margin-top: 4px;
            display: block;
            font-weight: 600;
        }

        .no-records {
            text-align: center;
            color: var(--text-sub);
            padding: 30px;
            font-style: italic;
            background: rgba(0,0,0,0.02);
            border-radius: var(--radius-sm);
        }

        .todo-input-section, .question-input-section, .plan-input-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: none;
            padding: 35px;
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: slideDown 0.3s;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h2 { font-size: 20px; font-weight: 700; margin: 0; color: var(--text-main); }
        
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: var(--text-main); }

        .modal-body { margin-bottom: 25px; }
        .modal-body label { display: block; color: var(--text-main); font-size: 14px; font-weight: 600; margin-bottom: 8px; margin-top: 15px; }
        .modal-body label:first-child { margin-top: 0; }

        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }

        @media (max-width: 1200px) {
            .main-layout { flex-wrap: wrap; }
            .left-section, .plan-section-container, .middle-section, .right-section { flex: 1 1 45%; }
        }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .container { padding: 20px; }
            .file-controls { flex-direction: column; align-items: stretch; }
            .file-controls .btn-finish { margin-left: 0; margin-top: 10px; }
            .clock-display { margin-left: 0; margin-top: 10px; justify-content: center; } 
            .auto-save-status { justify-content: center; margin-top: 10px; margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â±ï¸ ä»»åŠ¡æ—¶é—´è®°å½•ç³»ç»Ÿ - Cloud Pro</h1>
        
        <div class="file-controls">
            <label for="fileInput">ğŸ“‚ åŠ è½½æœ¬åœ°æ•°æ®</label>
            <input type="file" id="fileInput" accept=".json" onchange="loadFromFile(event)">
            
            <button class="btn-cloud-save" onclick="saveToCloudManual()">â˜ï¸ äº‘ç«¯å¤‡ä»½</button>
            
            <button class="btn-local-save" onclick="saveToLocal()">ğŸ’¾ æœ¬åœ°å¤‡ä»½</button>
            
            <button class="btn-finish" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºè¡¨æ ¼</button>
            
            <div id="sysClock" class="clock-display">00:00:00</div>

            <div class="auto-save-status">
                <span class="save-indicator"></span>
                <span id="saveStatus">å°±ç»ª</span>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="left-section">
                <div class="records">
                    <h2 class="section-title">ğŸ“… ä»Šæ—¥è¶³è¿¹</h2>
                    
                    <div class="task-input-section">
                        <input type="text" id="taskInput" placeholder="å‡†å¤‡å¼€å§‹ä»€ä¹ˆä»»åŠ¡ï¼Ÿ...">
                        
                        <div class="task-buttons-row">
                            <button class="btn-start" id="startBtn" onclick="startTask()">å¼€å§‹ä¸“æ³¨</button>
                            <button class="btn-pause" id="pauseBtn" onclick="pauseTask()" disabled>æš‚åœ</button>
                            <button class="btn-stop" id="stopBtn" onclick="stopTask()" disabled>å®Œæˆ</button>
                        </div>
                    </div>

                    <div class="current-task" id="currentTaskSection" style="display: none;">
                        <h2>æ­£åœ¨è¿›è¡Œ</h2>
                        <div id="currentTaskName"></div>
                        <div class="timer" id="timer">00:00:00</div>
                    </div>

                    <div id="recordsList">
                        <div class="no-records">ä»Šå¤©è¿˜æ²¡æœ‰å¼€å§‹è®°å½•ï¼ŒåŠ æ²¹ï¼</div>
                    </div>
                </div>
            </div>

            <div class="plan-section-container">
                <div class="plan-section">
                    <h2 class="section-title">ğŸ—“ï¸ ä»Šæ—¥è§„åˆ’</h2>
                    <div class="plan-input-section">
                        <input type="text" id="planInput" placeholder="è¾“å…¥ä»Šæ—¥è§„åˆ’...">
                        <button class="btn-add-plan" onclick="addDailyPlan()">æ·»åŠ è§„åˆ’</button>
                    </div>
                    <div id="planList">
                        <div class="no-records">æš‚æ— è§„åˆ’</div>
                    </div>
                </div>
            </div>

            <div class="middle-section">
                <div class="todo-section">
                    <h2 class="section-title">ğŸ“ å¾…åŠæ¸…å•</h2>
                    <div class="todo-input-section">
                        <input type="text" id="todoInput" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹...">
                        <input type="text" id="todoSubtitleInput" placeholder="è¡¥å……æè¿°ï¼ˆå¯é€‰ï¼‰...">
                        <input type="date" id="todoDeadline">
                        <button class="btn-add-todo" onclick="addTodo()">æ·»åŠ ä»»åŠ¡</button>
                    </div>
                    <div id="todoList">
                        <div class="no-records">æš‚æ— å¾…åŠ</div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <div class="question-section">
                    <h2 class="section-title">ğŸ’¡ çµæ„Ÿæ´å¯Ÿ</h2>
                    <div class="question-input-section">
                        <input type="text" id="questionInput" placeholder="æ•æ‰é—ªå¿µã€é—®é¢˜...">
                        <button class="btn-add-question" onclick="addQuestion()">è®°å½•æƒ³æ³•</button>
                    </div>
                    <div id="questionList">
                        <div class="no-records">é™å€™çµæ„Ÿé™ä¸´...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="todoEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ç¼–è¾‘å¾…åŠ</h2>
                <span class="close" onclick="closeTodoEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label>å¾…åŠå†…å®¹ï¼š</label>
                <input type="text" id="editTodoText" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹...">
                <label>è¡¥å……æè¿°ï¼š</label>
                <input type="text" id="editTodoSubtitle" placeholder="è¡¥å……ä»»åŠ¡æè¿°ï¼ˆå‰¯æ ‡é¢˜ï¼‰...">
                <label>æˆªæ­¢æ—¥æœŸï¼š</label>
                <input type="date" id="editTodoDeadline">
            </div>
            <div class="modal-footer">
                <button class="btn-save-modal" onclick="closeTodoEditModal()">å–æ¶ˆ</button>
                <button class="btn-start" onclick="saveTodoEdit()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div id="answerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’¡ æ·±åº¦æ€è€ƒ</h2>
                <span class="close" onclick="closeAnswerModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label>åŸå§‹å†…å®¹ï¼š</label>
                <p id="modalQuestionText" style="margin-bottom: 20px; color: var(--text-main); font-weight: 500; font-size: 16px; padding: 10px; background: var(--bg-gray); border-radius: 8px;"></p>
                <label>æ´å¯Ÿ/è§£å†³æ–¹æ¡ˆï¼š</label>
                <textarea id="answerInput" placeholder="åœ¨è¿™é‡Œæ·±åŒ–æ‚¨çš„æ€è€ƒï¼Œè®°å½•è§£å†³æ–¹æ¡ˆæˆ–åç»­è¡ŒåŠ¨..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-save-modal" onclick="closeAnswerModal()">å–æ¶ˆ</button>
                <button class="btn-start" onclick="saveAnswer()">ä¿å­˜è®°å½•</button>
            </div>
        </div>
    </div>

    <div id="descModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ ä»»åŠ¡å¤ç›˜</h2>
                <span class="close" onclick="closeDescModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label>ä»»åŠ¡åç§°ï¼š</label>
                <p id="modalRecordTask" style="margin-bottom: 20px; font-weight: 600; font-size: 16px;"></p>
                <label>è¡¥å……æè¿°/å¤ç›˜ï¼š</label>
                <textarea id="descInput" placeholder="è®°å½•è¿™ä¸ªä»»åŠ¡çš„å®Œæˆæƒ…å†µã€é‡åˆ°çš„é—®é¢˜æˆ–æˆæœ..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-save-modal" onclick="closeDescModal()">å–æ¶ˆ</button>
                <button class="btn-start" onclick="saveDescription()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¥ å¯¼å…¥æ•°æ®ç¡®è®¤</h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; font-size: 16px;">æ‚¨å¸Œæœ›å¦‚ä½•å¤„ç†æ•°æ®ï¼Ÿ</p>
                <div style="background: var(--bg-gray); padding: 15px; border-radius: 8px; font-size: 14px; color: var(--text-sub);">
                    <p style="margin-bottom: 8px;"><strong>é€‰é¡¹ 1: æ¸…ç©ºå¹¶å¯¼å…¥</strong><br>ä»…å¯¼å…¥å¾…åŠå’Œçµæ„Ÿï¼Œæ¸…ç©ºä»Šæ—¥çš„æ‰€æœ‰è®¡æ—¶è®°å½•ï¼ˆé€‚åˆæ–°çš„ä¸€å¤©ï¼‰ã€‚</p>
                    <p><strong>é€‰é¡¹ 2: å…¨éƒ¨å¯¼å…¥</strong><br>æ¢å¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬è®¡æ—¶è®°å½•ï¼ˆé€‚åˆæ¢å¤å·¥ä½œç°åœºï¼‰ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-save-modal" onclick="confirmImport(true)">æ¸…ç©ºè®°å½•</button>
                <button class="btn-start" onclick="confirmImport(false)">å…¨éƒ¨æ¢å¤</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // å…¨å±€å˜é‡å®šä¹‰
        // ==========================================
        window.currentTask = null;
        window.startTime = null;
        window.pausedTime = 0;
        window.timerInterval = null;
        window.isPaused = false;
        
        // æ•°æ®æ•°ç»„
        window.records = [];
        window.todos = [];
        window.questions = [];
        window.dailyPlans = []; 
        
        window.currentPlanId = null;
        
        let autoSaveInterval = null;
        let currentQuestionId = null;
        let currentRecordIndex = null;
        let currentTodoId = null;
        let pendingImportData = null;

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°æ‰€æœ‰åˆ—è¡¨ UI (ä¾›äº‘ç«¯åŒæ­¥è°ƒç”¨)
        window.refreshAllUI = function() {
            updateRecordsList();
            updateTodoList();
            updateQuestionList();
            updatePlanList(); 
        }

        window.addEventListener('DOMContentLoaded', () => {
            startAutoSave();
            updateRecordsList();
            updateTodoList();
            updateQuestionList();
            updatePlanList(); 
            
            // å¯åŠ¨æ—¶é’Ÿ
            updateSystemTime();
            setInterval(updateSystemTime, 1000);

            const hasData = checkIfHasData();
            if (!hasData) {
                updateSaveStatus('å°±ç»ª');
            }
        });
        
        function updateSystemTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('sysClock').textContent = timeStr;
        }

        function checkIfHasData() {
            return window.records.length > 0 || window.todos.length > 0 || window.questions.length > 0 || window.dailyPlans.length > 0 || window.currentTask !== null;
        }

        // ==========================================
        // ä¿®æ”¹ç‚¹ï¼šè‡ªåŠ¨ä¿å­˜é€»è¾‘
        // ==========================================
        function startAutoSave() {
            // æ¯10åˆ†é’Ÿ (600,000 ms) è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯
            autoSaveInterval = setInterval(() => {
                if (window.saveToCloud) {
                    window.saveToCloud(true);
                }
            }, 600000); 
        }

        // ==========================================
        // ä¿®æ”¹ç‚¹ï¼šæ•°æ®å¤‡ä»½ä¸äº‘ç«¯åŒæ­¥åŠŸèƒ½æ‹†åˆ†
        // ==========================================
        
        // åŠŸèƒ½1ï¼šæ‰‹åŠ¨äº‘ç«¯å¤‡ä»½
        function saveToCloudManual() {
            if (window.saveToCloud) {
                window.saveToCloud(false);
            } else {
                alert("äº‘ç«¯æœåŠ¡åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åå†è¯•...");
            }
        }

        // åŠŸèƒ½2ï¼šæœ¬åœ°å¤‡ä»½ (ä¸‹è½½ JSON)
        function saveToLocal() {
            const data = {
                records: window.records.map(r => ({
                    task: r.task,
                    duration: r.duration,
                    timestamp: r.timestamp instanceof Date ? r.timestamp.toISOString() : r.timestamp,
                    description: r.description || ''
                })),
                todos: window.todos,
                questions: window.questions,
                dailyPlans: window.dailyPlans, 
                
                currentTask: window.currentTask,
                currentPlanId: window.currentPlanId, 
                startTime: window.startTime,
                pausedTime: window.pausedTime,
                isPaused: window.isPaused,
                
                date: new Date().toDateString(),
                lastSaved: new Date().toISOString()
            };

            const jsonStr = JSON.stringify(data, null, 2);
            
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const timeStr = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}`;
            a.href = url;
            a.download = `backup_${timeStr}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            updateSaveStatus('âœ… æœ¬åœ°å·²å¤‡ä»½');
        }

        // è§„åˆ’ç›¸å…³åŠŸèƒ½
        function addDailyPlan() {
            const input = document.getElementById('planInput');
            const text = input.value.trim();
            if (!text) { alert("è¯·è¾“å…¥è§„åˆ’å†…å®¹"); return; }
            window.dailyPlans.push({
                id: Date.now(),
                content: text,
                completed: false,
                createdAt: new Date().toISOString()
            });
            input.value = '';
            updatePlanList();
        }

        function updatePlanList() {
            const listEl = document.getElementById('planList');
            if (window.dailyPlans.length === 0) { listEl.innerHTML = '<div class="no-records">æš‚æ— è§„åˆ’</div>'; return; }
            listEl.innerHTML = window.dailyPlans.map(item => `
                <div class="plan-item ${item.completed ? 'completed' : ''}">
                    <div>
                        <div class="plan-content">${item.content}</div>
                        <span class="plan-deadline">ä»Šæ—¥æˆªæ­¢</span>
                    </div>
                    ${!item.completed ? `
                    <div class="plan-actions">
                        <button class="btn-plan-action btn-to-footprint" onclick="startFromPlan(${item.id})">ğŸš€ å¼€å§‹æ‰§è¡Œ</button>
                        <button class="btn-plan-action btn-to-todo" onclick="convertPlanToTodo(${item.id})">ğŸ“ è½¬ä¸ºå¾…åŠ</button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function startFromPlan(id) {
            if (window.currentTask) { alert("å½“å‰å·²æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼Œè¯·å…ˆå®Œæˆæˆ–æš‚åœï¼"); return; }
            const plan = window.dailyPlans.find(p => p.id === id);
            if (!plan) return;
            document.getElementById('taskInput').value = plan.content;
            window.currentPlanId = id; 
            startTask();
        }

        function convertPlanToTodo(id) {
            const planIndex = window.dailyPlans.findIndex(p => p.id === id);
            if (planIndex === -1) return;
            const plan = window.dailyPlans[planIndex];
            window.todos.push({
                id: Date.now(),
                text: plan.content,
                subtitle: "æ¥è‡ªä»Šæ—¥è§„åˆ’çš„è¿ç§»",
                completed: false,
                deadline: new Date().toISOString().split('T')[0], 
                createdAt: new Date().toISOString()
            });
            window.dailyPlans.splice(planIndex, 1);
            updatePlanList();
            updateTodoList();
        }

        // ä»»åŠ¡æ§åˆ¶é€»è¾‘
        function startTask() {
            const taskInput = document.getElementById('taskInput');
            const taskName = taskInput.value.trim();
            if (!taskName) { alert('è¯·è¾“å…¥ä»»åŠ¡åç§°ï¼'); return; }

            window.currentTask = taskName;
            window.startTime = Date.now() - window.pausedTime;
            window.isPaused = false;
            
            document.getElementById('currentTaskSection').style.display = 'block';
            document.getElementById('currentTaskName').textContent = taskName;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            taskInput.disabled = true;

            window.timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTask() {
            clearInterval(window.timerInterval);
            const endTime = Date.now();
            const duration = window.pausedTime || (endTime - window.startTime);
            
            window.records.push({
                task: window.currentTask,
                duration: duration,
                timestamp: new Date(),
                description: ''
            });

            if (window.currentPlanId) {
                const plan = window.dailyPlans.find(p => p.id === window.currentPlanId);
                if (plan) plan.completed = true;
                window.currentPlanId = null; 
                updatePlanList();
            }

            updateRecordsList();
            resetTask();
        }

        function pauseTask() {
            if (window.isPaused) {
                window.startTime = Date.now() - window.pausedTime;
                window.isPaused = false;
                window.timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('pauseBtn').textContent = 'ç»§ç»­';
            } else {
                clearInterval(window.timerInterval);
                window.pausedTime = Date.now() - window.startTime;
                window.isPaused = true;
                document.getElementById('pauseBtn').textContent = 'ç»§ç»­';
            }
        }

        function resetTask() {
            window.currentTask = null;
            window.startTime = null;
            window.pausedTime = 0;
            window.isPaused = false;
            window.currentPlanId = null; 
            
            document.getElementById('currentTaskSection').style.display = 'none';
            document.getElementById('timer').textContent = '00:00:00';
            document.getElementById('taskInput').value = '';
            document.getElementById('taskInput').disabled = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = 'æš‚åœ';
            document.getElementById('stopBtn').disabled = true;
        }

        window.updateTimer = function() {
            if (!window.startTime) return;
            const elapsed = Date.now() - window.startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('timer').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function confirmImport(clearRecords) {
            if (!pendingImportData) return;

            try {
                const data = pendingImportData;
                window.todos = data.todos || [];
                window.questions = data.questions || [];
                window.dailyPlans = data.dailyPlans || []; 
                
                if (!clearRecords) {
                    window.records = (data.records || []).map(r => ({
                        task: r.task || 'æœªçŸ¥ä»»åŠ¡',
                        duration: Number(r.duration) || 0,
                        timestamp: r.timestamp ? new Date(r.timestamp) : new Date(),
                        description: r.description || ''
                    }));
                    
                    window.currentTask = data.currentTask;
                    window.currentPlanId = data.currentPlanId || null;
                    window.startTime = data.startTime;
                    window.pausedTime = data.pausedTime;
                    window.isPaused = data.isPaused;

                    if (window.currentTask && window.startTime) {
                        document.getElementById('currentTaskSection').style.display = 'block';
                        document.getElementById('currentTaskName').textContent = window.currentTask;
                        document.getElementById('taskInput').value = window.currentTask;
                        document.getElementById('taskInput').disabled = true;
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('pauseBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = false;

                        if (window.isPaused) {
                            document.getElementById('pauseBtn').textContent = 'ç»§ç»­';
                        } else {
                            if (window.timerInterval) clearInterval(window.timerInterval);
                            window.timerInterval = setInterval(updateTimer, 1000);
                        }
                        updateTimer();
                    }
                } else {
                    window.records = []; 
                    resetTask();
                }

                refreshAllUI();
                closeImportModal();
                updateSaveStatus('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                
                if (window.saveToCloud) {
                    window.saveToCloud(true);
                }

            } catch (err) {
                console.error("å¯¼å…¥å‡ºé”™:", err);
                alert("å¯¼å…¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
            }
        }
        
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    pendingImportData = JSON.parse(e.target.result);
                    document.getElementById('importModal').style.display = 'block';
                } catch (error) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; pendingImportData = null; }
        function updateSaveStatus(msg) { document.getElementById('saveStatus').textContent = msg; }
        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function addTodo() {
            const todoInput = document.getElementById('todoInput');
            const subtitleInput = document.getElementById('todoSubtitleInput');
            const deadlineInput = document.getElementById('todoDeadline');
            if (!todoInput.value.trim()) return alert('è¯·è¾“å…¥å¾…åŠäº‹é¡¹ï¼');
            window.todos.push({
                id: Date.now(),
                text: todoInput.value.trim(),
                subtitle: subtitleInput.value.trim(),
                completed: false,
                deadline: deadlineInput.value || null,
                createdAt: new Date().toISOString()
            });
            todoInput.value = ''; subtitleInput.value = ''; deadlineInput.value = '';
            updateTodoList();
        }
        function toggleTodo(id) {
            const todo = window.todos.find(t => t.id === id);
            if(todo) {
                todo.completed = !todo.completed;
                if(todo.completed) setTimeout(() => { window.todos = window.todos.filter(t => t.id !== id); updateTodoList(); }, 500);
                updateTodoList();
            }
        }
        function isOverdue(deadline) {
            if (!deadline) return false;
            const today = new Date(); today.setHours(0,0,0,0);
            return new Date(deadline) < today;
        }
        function formatDeadline(deadline) {
            if (!deadline) return '';
            const diffDays = Math.ceil((new Date(deadline) - new Date().setHours(0,0,0,0)) / (86400000));
            return diffDays < 0 ? `é€¾æœŸ ${Math.abs(diffDays)} å¤©` : (diffDays === 0 ? 'ä»Šå¤©æˆªæ­¢' : (diffDays === 1 ? 'æ˜å¤©æˆªæ­¢' : `${diffDays} å¤©å`));
        }
        function updateTodoList() {
            const list = document.getElementById('todoList');
            if(window.todos.length === 0) { list.innerHTML = '<div class="no-records">æš‚æ— å¾…åŠ</div>'; return; }
            list.innerHTML = window.todos.map(todo => `
                <div class="todo-item ${todo.completed?'completed':''} ${isOverdue(todo.deadline)?'overdue':''}">
                    <div class="todo-header">
                        <input type="checkbox" class="todo-checkbox" ${todo.completed?'checked':''} onchange="toggleTodo(${todo.id})">
                        <div class="todo-content">
                            <div class="todo-text">${todo.text}</div>
                            ${todo.subtitle?`<div class="todo-subtitle">${todo.subtitle}</div>`:''}
                            ${todo.deadline?`<div class="todo-deadline">ğŸ“… ${formatDeadline(todo.deadline)}</div>`:''}
                        </div>
                    </div>
                    <button class="btn-start btn-small" style="background:var(--bg-gray); color:var(--text-sub); border:1px solid var(--border-color);" onclick="openTodoEditModal(${todo.id})">ç¼–è¾‘</button>
                </div>`).join('');
        }
        function openTodoEditModal(id) {
            const todo = window.todos.find(t => t.id === id);
            if(!todo) return;
            currentTodoId = id;
            document.getElementById('editTodoText').value = todo.text;
            document.getElementById('editTodoSubtitle').value = todo.subtitle||'';
            document.getElementById('editTodoDeadline').value = todo.deadline||'';
            document.getElementById('todoEditModal').style.display = 'block';
        }
        function closeTodoEditModal() { document.getElementById('todoEditModal').style.display = 'none'; currentTodoId = null; }
        function saveTodoEdit() {
            const todo = window.todos.find(t => t.id === currentTodoId);
            if(todo) {
                todo.text = document.getElementById('editTodoText').value.trim();
                todo.subtitle = document.getElementById('editTodoSubtitle').value.trim();
                todo.deadline = document.getElementById('editTodoDeadline').value || null;
                updateTodoList();
            }
            closeTodoEditModal();
        }
        
        function addQuestion() {
            const val = document.getElementById('questionInput').value.trim();
            if(!val) return alert('è¯·è¾“å…¥å†…å®¹ï¼');
            window.questions.push({ id: Date.now(), question: val, answer: '', answered: false, createdAt: new Date().toISOString() });
            document.getElementById('questionInput').value = ''; updateQuestionList();
        }
        function updateQuestionList() {
            const list = document.getElementById('questionList');
            if(window.questions.length === 0) { list.innerHTML = '<div class="no-records">é™å€™çµæ„Ÿé™ä¸´...</div>'; return; }
            list.innerHTML = window.questions.map(q => `
                <div class="question-item ${q.answered?'answered':''}">
                    <div class="question-content" onclick="openAnswerModal(${q.id})">
                        <div class="question-text">${q.question}</div>
                        ${q.answered?'<span class="question-status">âœ“ å·²è®°å½•æ´å¯Ÿ</span>':''}
                    </div>
                    <button class="btn-delete btn-small" onclick="deleteQuestion(${q.id})">åˆ é™¤</button>
                </div>`).join('');
        }
        function deleteQuestion(id) { if(confirm('åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) { window.questions = window.questions.filter(q=>q.id!==id); updateQuestionList(); } }
        function openAnswerModal(id) {
            const q = window.questions.find(x=>x.id===id);
            if(!q) return;
            currentQuestionId = id;
            document.getElementById('modalQuestionText').textContent = q.question;
            document.getElementById('answerInput').value = q.answer||'';
            document.getElementById('answerModal').style.display = 'block';
        }
        function closeAnswerModal() { document.getElementById('answerModal').style.display = 'none'; currentQuestionId = null; }
        function saveAnswer() {
            const q = window.questions.find(x=>x.id===currentQuestionId);
            if(q) { q.answer = document.getElementById('answerInput').value.trim(); q.answered = q.answer.length>0; updateQuestionList(); }
            closeAnswerModal();
        }

        function updateRecordsList() {
            const list = document.getElementById('recordsList');
            if(window.records.length === 0) { list.innerHTML = '<div class="no-records">ä»Šå¤©è¿˜æ²¡æœ‰å¼€å§‹è®°å½•ï¼ŒåŠ æ²¹ï¼</div>'; return; }
            list.innerHTML = window.records.slice().reverse().map((r, i) => {
                let timeStr = 'å†å²è®°å½•';
                try {
                    let end = r.timestamp instanceof Date ? r.timestamp : new Date(r.timestamp);
                    let start = new Date(end.getTime() - r.duration);
                    timeStr = `${start.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})} -> ${end.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}`;
                } catch(e){}
                return `
                <div class="record-item">
                    <div class="record-header">
                        <div><div class="record-task">${r.task}</div><small style="color:var(--text-sub)">${timeStr}</small></div>
                        <div class="record-time">${formatDuration(r.duration)}</div>
                    </div>
                    ${r.description?`<div class="record-desc">${r.description}</div>`:''}
                    <div style="margin-top:10px"><button class="btn-small" style="background:var(--bg-gray);color:var(--text-sub);border:1px solid var(--border-color)" onclick="openDescModal(${window.records.length - 1 - i})">${r.description?'ç¼–è¾‘å¤ç›˜':'æ·»åŠ å¤ç›˜'}</button></div>
                </div>`;
            }).join('');
        }
        function openDescModal(idx) { currentRecordIndex = idx; document.getElementById('modalRecordTask').textContent = window.records[idx].task; document.getElementById('descInput').value = window.records[idx].description||''; document.getElementById('descModal').style.display = 'block'; }
        function closeDescModal() { document.getElementById('descModal').style.display = 'none'; currentRecordIndex = null; }
        function saveDescription() { if(currentRecordIndex!==null){ window.records[currentRecordIndex].description = document.getElementById('descInput').value.trim(); updateRecordsList(); closeDescModal(); } }
        
        function exportToExcel() {
            if(window.records.length===0) return alert('æ— è®°å½•å¯å¯¼å‡º');
            const data = window.records.map((r,i) => ({
                'åºå·': i+1, 'ä»»åŠ¡': r.task, 'ç”¨æ—¶': formatDuration(r.duration),
                'å¤ç›˜': r.description||''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Records');
            XLSX.writeFile(wb, `Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCgS797yXzTcDRBNHF0pbYYsdKe0b_WB0o",
        authDomain: "time-tracker-bdb56.firebaseapp.com",
        projectId: "time-tracker-bdb56",
        storageBucket: "time-tracker-bdb56.firebasestorage.app",
        messagingSenderId: "52472082666",
        appId: "1:52472082666:web:96f2a3b9025adb568be793",
        measurementId: "G-HN93S2R6WX"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const USER_DOC_ID = "my_daily_data"; 

      // 1. äº‘ç«¯ä¿å­˜å‡½æ•°
      window.saveToCloud = async function(isAuto = false) {
        const data = {
            records: window.records || [],
            todos: window.todos || [],
            questions: window.questions || [],
            dailyPlans: window.dailyPlans || [], 
            
            currentTask: window.currentTask || null,
            currentPlanId: window.currentPlanId || null, 
            startTime: window.startTime || null,
            pausedTime: window.pausedTime || 0,
            isPaused: window.isPaused || false,
            
            lastUpdated: new Date().toISOString()
        };

        try {
            await setDoc(doc(db, "tracker_data", USER_DOC_ID), data);
            
            const statusText = isAuto ? 'â˜ï¸ äº‘ç«¯å·²è‡ªåŠ¨åŒæ­¥' : 'â˜ï¸ äº‘ç«¯ä¿å­˜æˆåŠŸ';
            if (!isAuto) document.getElementById('saveStatus').textContent = statusText;
        } catch (e) {
            console.error("Cloud Error: ", e);
            document.getElementById('saveStatus').textContent = 'âŒ äº‘ç«¯åŒæ­¥å¤±è´¥';
        }
      };

      // 2. å®æ—¶ç›‘å¬
      onSnapshot(doc(db, "tracker_data", USER_DOC_ID), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            window.records = (data.records || []).map(r => ({ ...r, timestamp: r.timestamp ? new Date(r.timestamp) : new Date() }));
            window.todos = data.todos || [];
            window.questions = data.questions || [];
            window.dailyPlans = data.dailyPlans || [];
            
            window.currentTask = data.currentTask;
            window.currentPlanId = data.currentPlanId;
            window.startTime = data.startTime;
            window.pausedTime = data.pausedTime;
            window.isPaused = data.isPaused;

            if (window.refreshAllUI) window.refreshAllUI();
            
            const taskSection = document.getElementById('currentTaskSection');
            if (window.currentTask) {
                taskSection.style.display = 'block';
                document.getElementById('currentTaskName').textContent = window.currentTask;
                document.getElementById('taskInput').value = window.currentTask;
                document.getElementById('taskInput').disabled = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                
                if (window.timerInterval) clearInterval(window.timerInterval);
                if (!window.isPaused) {
                     window.timerInterval = setInterval(window.updateTimer, 1000);
                     document.getElementById('pauseBtn').textContent = 'æš‚åœ';
                } else {
                    document.getElementById('pauseBtn').textContent = 'ç»§ç»­';
                    if(window.updateTimer) window.updateTimer();
                }
            } else {
                taskSection.style.display = 'none';
                if (window.timerInterval) clearInterval(window.timerInterval);
                document.getElementById('taskInput').disabled = false;
                document.getElementById('startBtn').disabled = false;
            }
            document.getElementById('saveStatus').textContent = 'â˜ï¸ æ•°æ®å·²åŒæ­¥';
        }
      });
    </script>
</body>
</html>
